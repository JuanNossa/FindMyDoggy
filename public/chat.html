<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat - FindMyDoggy</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.1/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container-fluid">
    <div class="row vh-100">
      <!-- Panel de Chats (lista) -->
      <div class="col-md-3 bg-light border-end">
        <h5 class="mt-3">Chats</h5>
        <ul class="list-group" id="chatList">
          <!-- Lista de chats generada dinámicamente -->
        </ul>
      </div>
      <!-- Panel de Conversación -->
      <div class="col-md-9 d-flex flex-column">
        <div id="chatConversation" class="flex-grow-1 border mb-3 p-3 overflow-auto">
          <!-- Mensajes del chat -->
        </div>
        <div class="input-group mb-3">
          <input type="text" id="chatMessageInput" class="form-control" placeholder="Escribe tu mensaje...">
          <button class="btn btn-primary" id="btnSendChat">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Conectar al Socket.IO usando token de JWT (obtenido de localStorage)
    const token = localStorage.getItem('token');
    // Enviar token en el handshake auth (el back lo valida)
    const socket = io('http://localhost:3000', { auth: { token } });

    // Suponiendo que se obtiene la lista de chats desde el servidor; aquí se simula:
    const chatList = document.getElementById('chatList');
    // Ejemplo: un chat con un usuario llamado "Carlos"
    chatList.innerHTML = `<li class="list-group-item" data-room="chat_1_2">Carlos</li>`;

    // Al hacer clic en un chat, unirse a la sala correspondiente y cargar el historial
    chatList.addEventListener('click', function(e) {
      if (e.target && e.target.matches("li.list-group-item")) {
        const room = e.target.getAttribute('data-room');
        socket.emit('joinRoom', room);
      }
    });

    // Enviar mensaje
    document.getElementById('btnSendChat').addEventListener('click', function() {
      const room = document.querySelector('li.list-group-item.active')?.getAttribute('data-room') || 'chat_1_2';
      const sender = localStorage.getItem('userId'); // o usar el nombre almacenado
      const message = document.getElementById('chatMessageInput').value;
      socket.emit('chatMessage', { room, sender, message });
      document.getElementById('chatMessageInput').value = '';
    });

    // Mostrar mensajes entrantes
    socket.on('chatMessage', (data) => {
      const chatConversation = document.getElementById('chatConversation');
      const msgDiv = document.createElement('div');
      msgDiv.textContent = `${data.sender}: ${data.message}`;
      chatConversation.appendChild(msgDiv);
    });

    // Opcional: recibir historial de chat
    socket.on('chatHistory', (history) => {
      const chatConversation = document.getElementById('chatConversation');
      chatConversation.innerHTML = ''; // Limpiar
      history.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.textContent = `${msg.sender}: ${msg.message}`;
        chatConversation.appendChild(msgDiv);
      });
    });
  </script>
</body>
</html>